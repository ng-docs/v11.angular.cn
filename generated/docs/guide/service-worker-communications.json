{"id":"guide/service-worker-communications","title":"Service worker communication","contents":"\n\n\n<div class=\"github-links\">\n  <a href=\"https://github.com/angular/angular-cn/edit/aio/aio/content/guide/service-worker-communications.md?message=docs%3A%20请简述你的修改...\" aria-label=\"提供编辑建议\" title=\"提供编辑建议\"><i class=\"material-icons\" aria-hidden=\"true\" role=\"img\">mode_edit</i></a>\n</div>\n\n\n<div class=\"content\">\n  <h1 id=\"service-worker-communication\" translation-result=\"on\">与 Service Worker 通讯<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#service-worker-communication\"><i class=\"material-icons\">link</i></a></h1><h1 translation-origin=\"off\" id=\"service-worker-communication\">Service worker communication<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#service-worker-communication\"><i class=\"material-icons\">link</i></a></h1>\n\n<p translation-result=\"on\">把 <code><a href=\"api/service-worker/ServiceWorkerModule\" class=\"code-anchor\">ServiceWorkerModule</a></code> 导入到你的 <code>AppModule</code> 中不仅会注册 Service Worker，还会提供一些服务，让你能和 Service Worker 通讯，并控制你的应用缓存。</p><p translation-origin=\"off\">Importing <code><a href=\"api/service-worker/ServiceWorkerModule\" class=\"code-anchor\">ServiceWorkerModule</a></code> into your <code>AppModule</code> doesn't just register the service worker, it also provides a few services you can use to interact with the service worker and control the caching of your application.</p>\n\n<h4 id=\"prerequisites\" translation-result=\"on\">前提条件<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#prerequisites\"><i class=\"material-icons\">link</i></a></h4><h4 translation-origin=\"off\" id=\"prerequisites\">Prerequisites<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#prerequisites\"><i class=\"material-icons\">link</i></a></h4>\n\n<p translation-result=\"on\">对下列知识有基本的了解：</p><p translation-origin=\"off\">A basic understanding of the following:</p>\n\n<ul>\n<li>\n<p translation-result=\"on\"> <a href=\"guide/service-worker-getting-started\">Service Worker 快速上手</a>。</p><p translation-origin=\"off\"><a href=\"guide/service-worker-getting-started\">Getting Started with Service Workers</a>.</p>\n\n</li>\n</ul>\n<h2 id=\"swupdate-service\" translation-result=\"on\"><code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> 服务<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#swupdate-service\"><i class=\"material-icons\">link</i></a></h2><h2 translation-origin=\"off\" id=\"swupdate-service\"><code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> service<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#swupdate-service\"><i class=\"material-icons\">link</i></a></h2>\n\n<p translation-result=\"on\"><code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> 服务让你能访问一些事件，这些事件会指出 Service Worker 何时发现了可用的更新或者一个更新何时可以被激活 —— 这意味着它现在可以通过更新后的版本提供服务了。</p><p translation-origin=\"off\">The <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> service gives you access to events that indicate when the service worker has discovered an available update for your application or when it has activated such an update—meaning it is now serving content from that update to your application.</p>\n\n<p translation-result=\"on\"><code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> 服务支持四个独立的操作：</p><p translation-origin=\"off\">The <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> service supports four separate operations:</p>\n\n<ul>\n<li>\n<p translation-result=\"on\"> 获取出现<em>可用</em>更新的通知。如果要刷新页面，这些就是可加载的新版本。</p><p translation-origin=\"off\">Getting notified of <em>available</em> updates. These are new versions of the application to be loaded if the page is refreshed.</p>\n\n</li>\n<li>\n<p translation-result=\"on\"> 获取更新<em>被激活</em>的通知。这时候 Service Worker 就可以立即使用这些新版本提供服务了。</p><p translation-origin=\"off\">Getting notified of update <em>activation</em>. This is when the service worker starts serving a new version of the application immediately.</p>\n\n</li>\n<li>\n<p translation-result=\"on\"> 要求 Service Worker 向服务器查询是否有新版本。</p><p translation-origin=\"off\">Asking the service worker to check the server for new updates.</p>\n\n</li>\n<li>\n<p translation-result=\"on\"> 要求 Service Worker 为当前标签页激活该应用的最新版本。</p><p translation-origin=\"off\">Asking the service worker to activate the latest version of the application for the current tab.</p>\n\n</li>\n</ul>\n<h3 id=\"available-and-activated-updates\" translation-result=\"on\">有可用更新及已激活更新<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#available-and-activated-updates\"><i class=\"material-icons\">link</i></a></h3><h3 translation-origin=\"off\" id=\"available-and-activated-updates\">Available and activated updates<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#available-and-activated-updates\"><i class=\"material-icons\">link</i></a></h3>\n\n<p translation-result=\"on\">这两个更新事件 <code>available</code> 和 <code>activated</code>，都是 <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> 的 <code>Observable</code> 属性：</p><p translation-origin=\"off\">The two update events, <code>available</code> and <code>activated</code>, are <code>Observable</code> properties of <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code>:</p>\n\n<code-example path=\"service-worker-getting-started/src/app/log-update.service.ts\" header=\"log-update.service.ts\" region=\"sw-update\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>()\nexport class LogUpdateService {\n\n  constructor(updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    updates.available.subscribe(event => {\n      console.log('current version is', event.current);\n      console.log('available version is', event.available);\n    });\n    updates.activated.subscribe(event => {\n      console.log('old version was', event.previous);\n      console.log('new version is', event.current);\n    });\n  }\n}\n\n</code-example>\n<p translation-result=\"on\">你可以使用这些事件来通知用户有一个待做更新或当它们运行的代码已经过期时刷新页面。</p><p translation-origin=\"off\">You can use these events to notify the user of a pending update or to refresh their pages when the code they are running is out of date.</p>\n\n<h3 id=\"checking-for-updates\" translation-result=\"on\">检查更新<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#checking-for-updates\"><i class=\"material-icons\">link</i></a></h3><h3 translation-origin=\"off\" id=\"checking-for-updates\">Checking for updates<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#checking-for-updates\"><i class=\"material-icons\">link</i></a></h3>\n\n<p translation-result=\"on\">可以要求 Service Worker 检查是否有任何更新已经发布到了服务器上。\nService Worker 会在初始化和每次导航请求（也就是用户导航到应用中的另一个地址）时检查更新。\n不过，如果你的站点更新非常频繁，或者需要按计划进行更新，你可能会选择手动检查更新。</p><p translation-origin=\"off\">It's possible to ask the service worker to check if any updates have been deployed to the server.\nThe service worker checks for updates during initialization and on each navigation request—that is, when the user navigates from a different address to your application.\nHowever, you might choose to manually check for updates if you have a site that changes frequently or want updates to happen on a schedule.</p>\n\n<p translation-result=\"on\">通过调用 <code>checkForUpdate()</code> 方法来实现：</p><p translation-origin=\"off\">Do this with the <code>checkForUpdate()</code> method:</p>\n\n<code-example path=\"service-worker-getting-started/src/app/check-for-update.service.ts\" header=\"check-for-update.service.ts\">\nimport { <a href=\"api/core/ApplicationRef\" class=\"code-anchor\">ApplicationRef</a>, <a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a> } from '@angular/core';\nimport { <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a> } from '@angular/service-worker';\nimport { concat, interval } from 'rxjs';\nimport { first } from 'rxjs/operators';\n\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>()\nexport class CheckForUpdateService {\n\n  constructor(appRef: <a href=\"api/core/ApplicationRef\" class=\"code-anchor\">ApplicationRef</a>, updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    // Allow the app to stabilize first, before starting polling for updates with `interval()`.\n    const appIsStable$ = appRef.isStable.pipe(first(isStable => isStable === true));\n    const everySixHours$ = interval(6 * 60 * 60 * 1000);\n    const everySixHoursOnceAppIsStable$ = concat(appIsStable$, everySixHours$);\n\n    everySixHoursOnceAppIsStable$.subscribe(() => updates.checkForUpdate());\n  }\n}\n\n\n</code-example>\n<p translation-result=\"on\">该方法返回一个用来表示检查更新已经成功完成的 <code>Promise</code>，不过它不会指出是否确实发现了一个更新。\n即使找到了一个，Service Worker 还必须成功下载更新过的文件，而这可能会失败。如果成功了，就会通过一个 <code>available</code> 事件来表明当前应用有一个可用的新版本。</p><p translation-origin=\"off\">This method returns a <code>Promise</code> which indicates that the update check has completed successfully, though it does not indicate whether an update was discovered as a result of the check. Even if one is found, the service worker must still successfully download the changed files, which can fail. If successful, the <code>available</code> event will indicate availability of a new version of the application.</p>\n\n<div class=\"alert is-important\">\n<p translation-result=\"on\">为了避免影响页面的首次渲染，在注册 ServiceWorker 脚本之前，<code><a href=\"api/service-worker/ServiceWorkerModule\" class=\"code-anchor\">ServiceWorkerModule</a></code> 默认会在应用程序达到稳定态之前等待最多 30 秒。如果不断轮询更新（比如调用 <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval\">setInterval()</a> 或 RxJS 的 <a href=\"https://rxjs.dev/api/index/function/interval\">interval()</a>）就会阻止应用程序达到稳定态，则直到 30 秒结束之前都不会往浏览器中注册 ServiceWorker 脚本。</p><p translation-origin=\"off\">In order to avoid negatively affecting the initial rendering of the page, <code><a href=\"api/service-worker/ServiceWorkerModule\" class=\"code-anchor\">ServiceWorkerModule</a></code> waits for up to 30 seconds by default for the application to stabilize, before registering the ServiceWorker script.\nConstantly polling for updates, for example, with <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval\">setInterval()</a> or RxJS' <a href=\"https://rxjs.dev/api/index/function/interval\">interval()</a>, will prevent the application from stabilizing and the ServiceWorker script will not be registered with the browser until the 30 seconds upper limit is reached.</p>\n\n<p translation-result=\"on\">请注意，应用中所执行的各种轮询都会阻止它达到稳定态。欲知详情，参阅 <a href=\"api/core/ApplicationRef#isStable\">isStable</a> 文档。</p><p translation-origin=\"off\">Note that this is true for any kind of polling done by your application.\nCheck the <a href=\"api/core/ApplicationRef#isStable\">isStable</a> documentation for more information.</p>\n\n<p translation-result=\"on\">你可以通过在开始轮询更新之前先等应用达到稳定态来消除这种延迟，如下面的例子所示。\n另外，你还可以为 ServiceWorker 定义不一样的 <a href=\"api/service-worker/SwRegistrationOptions#registrationStrategy\">注册策略</a>。</p><p translation-origin=\"off\">You can avoid that delay by waiting for the application to stabilize first, before starting to poll for updates, as shown in the example above.\nAlternatively, you might want to define a different <a href=\"api/service-worker/SwRegistrationOptions#registrationStrategy\">registration strategy</a> for the ServiceWorker.</p>\n\n</div>\n<h3 id=\"forcing-update-activation\" translation-result=\"on\">强制激活更新<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#forcing-update-activation\"><i class=\"material-icons\">link</i></a></h3><h3 translation-origin=\"off\" id=\"forcing-update-activation\">Forcing update activation<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#forcing-update-activation\"><i class=\"material-icons\">link</i></a></h3>\n\n<p translation-result=\"on\">如果当前标签页需要立即更新到最新的应用版本，可以通过 <code>activateUpdate()</code> 方法来要求立即这么做：</p><p translation-origin=\"off\">If the current tab needs to be updated to the latest application version immediately, it can ask to do so with the <code>activateUpdate()</code> method:</p>\n\n<code-example path=\"service-worker-getting-started/src/app/prompt-update.service.ts\" header=\"prompt-update.service.ts\" region=\"sw-activate\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>()\nexport class PromptUpdateService {\n\n  constructor(updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    updates.available.subscribe(event => {\n      if (promptUser(event)) {\n        updates.activateUpdate().then(() => document.location.reload());\n      }\n    });\n  }\n}\n\n</code-example>\n<div class=\"alert is-important\">\n<p translation-result=\"on\">如果调用 <code>activateUpdate()</code> 而不刷新页面，可能会破坏正在运行的应用中的惰性加载模块，特别是如果惰性加载的模块文件名中使用了哈希时，就会改变每一个版本。\n所以，建议每当 <code>activateUpdate()</code> 返回的 Promise 被解析时，都刷新一次页面。</p><p translation-origin=\"off\">Calling <code>activateUpdate()</code> without reloading the page could break lazy-loading in a currently running app, especially if the lazy-loaded chunks use filenames with hashes, which change every version.\nTherefore, it is recommended to reload the page once the promise returned by <code>activateUpdate()</code> is resolved.</p>\n\n</div>\n<h3 id=\"handling-an-unrecoverable-state\" translation-result=\"on\">处理不可恢复的状态<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#handling-an-unrecoverable-state\"><i class=\"material-icons\">link</i></a></h3><h3 translation-origin=\"off\" id=\"handling-an-unrecoverable-state\">Handling an unrecoverable state<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#handling-an-unrecoverable-state\"><i class=\"material-icons\">link</i></a></h3>\n\n<p translation-result=\"on\">在某些情况下，Service Worker 用来为客户端提供服务的应用版本可能处于损坏状态，如果不重新加载整个页面，则无法恢复该状态。</p><p translation-origin=\"off\">In some cases, the version of the application used by the service worker to serve a client might be in a broken state that cannot be recovered from without a full page reload.</p>\n\n<p translation-result=\"on\">例如，设想以下情形：</p><p translation-origin=\"off\">For example, imagine the following scenario:</p>\n\n<ul>\n<li>\n<p translation-result=\"on\">用户首次打开该应用，Service Worker 会缓存该应用的最新版本。假设应用要缓存的资源包括 <code>index.html</code>、<code>main.&#x3C;main-hash-1>.js</code> 和 <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code> 。</p><p translation-origin=\"off\">A user opens the application for the first time and the service worker caches the latest version of the application.\nLet's assume the application's cached assets include <code>index.html</code>, <code>main.&#x3C;main-hash-1>.js</code> and <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code>.</p>\n\n</li>\n<li>\n<p translation-result=\"on\">用户关闭该应用程序，并且有一段时间没有打开它。</p><p translation-origin=\"off\">The user closes the application and does not open it for a while.</p>\n\n</li>\n<li>\n<p translation-result=\"on\">一段时间后，会将新版本的应用程序部署到服务器。新版本中包含文件 <code>index.html</code>、<code>main.&#x3C;main-hash-2>.js</code> 和 <code>lazy-chunk.&#x3C;lazy-hash-2>.js</code> （请注意，哈希值现在已经不同了，因为文件的内容已经改变）。服务器上不再提供旧版本。</p><p translation-origin=\"off\">After some time, a new version of the application is deployed to the server.\nThis newer version includes the files <code>index.html</code>, <code>main.&#x3C;main-hash-2>.js</code> and <code>lazy-chunk.&#x3C;lazy-hash-2>.js</code> (note that the hashes are different now, because the content of the files has changed).\nThe old version is no longer available on the server.</p>\n\n</li>\n<li>\n<p translation-result=\"on\">同时，用户的浏览器决定从其缓存中清退 <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code> 浏览器可能决定从缓存中清退特定（或所有）资源，以便回收磁盘空间。</p><p translation-origin=\"off\">In the meantime, the user's browser decides to evict <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code> from its cache.\nBrowsers may decide to evict specific (or all) resources from a cache in order to reclaim disk space.</p>\n\n</li>\n<li>\n<p translation-result=\"on\">用户再次打开本应用。此时，Service Worker 将提供它所知的最新版本，当然，实际上对我们是旧版本（ <code>index.html</code> 和 <code>main.&#x3C;main-hash-1>.js</code> ）。</p><p translation-origin=\"off\">The user opens the application again.\nThe service worker serves the latest version known to it at this point, namely the old version (<code>index.html</code> and <code>main.&#x3C;main-hash-1>.js</code>).</p>\n\n</li>\n<li>\n<p translation-result=\"on\">在稍后的某个时刻，该应用程序请求惰性捆绑包 <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code> 。</p><p translation-origin=\"off\">At some later point, the application requests the lazy bundle, <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code>.</p>\n\n</li>\n<li>\n<p translation-result=\"on\">Service Worker 无法在缓存中找到该资产（请记住浏览器已经将其清退了）。它也无法从服务器上获取它（因为服务器现在只有较新版本的 <code>lazy-chunk.&#x3C;lazy-hash-2>.js</code>）</p><p translation-origin=\"off\">The service worker is unable to find the asset in the cache (remember that the browser evicted it).\nNor is it able to retrieve it from the server (since the server now only has <code>lazy-chunk.&#x3C;lazy-hash-2>.js</code> from the newer version).</p>\n\n</li>\n</ul>\n<p translation-result=\"on\">在上述情况下，Service Worker 将无法提供通常会被缓存的资产。该特定的应用程序版本已损坏，并且无法在不重新加载页面的情况下修复客户端的状态。在这种情况下，Service Worker 会通过发送 <code><a href=\"api/service-worker/UnrecoverableStateEvent\" class=\"code-anchor\">UnrecoverableStateEvent</a></code> 事件来通知客户端。你可以订阅 <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>#unrecoverable</code> 以得到通知并处理这些错误。</p><p translation-origin=\"off\">In the above scenario, the service worker is not able to serve an asset that would normally be cached.\nThat particular application version is broken and there is no way to fix the state of the client without reloading the page.\nIn such cases, the service worker notifies the client by sending an <code><a href=\"api/service-worker/UnrecoverableStateEvent\" class=\"code-anchor\">UnrecoverableStateEvent</a></code> event.\nYou can subscribe to <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>#unrecoverable</code> to be notified and handle these errors.</p>\n\n<code-example path=\"service-worker-getting-started/src/app/handle-unrecoverable-state.service.ts\" header=\"handle-unrecoverable-state.service.ts\" region=\"sw-unrecoverable-state\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>()\nexport class HandleUnrecoverableStateService {\n  constructor(updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    updates.unrecoverable.subscribe(event => {\n      notifyUser(\n        `An error occurred that we cannot recover from:\\n${event.reason}\\n\\n` +\n        'Please reload the page.');\n    });\n  }\n}\n\n</code-example>\n<h2 id=\"more-on-angular-service-workers\" translation-result=\"on\">关于 Angular Service Worker 的更多信息<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#more-on-angular-service-workers\"><i class=\"material-icons\">link</i></a></h2><h2 translation-origin=\"off\" id=\"more-on-angular-service-workers\">More on Angular service workers<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#more-on-angular-service-workers\"><i class=\"material-icons\">link</i></a></h2>\n\n<p translation-result=\"on\">你可能还对下列内容感兴趣：</p><p translation-origin=\"off\">You may also be interested in the following:</p>\n\n<ul>\n<li>\n<p translation-result=\"on\"> <a href=\"guide/service-worker-devops\">生产环境下的 Service Worker</a>。</p><p translation-origin=\"off\"><a href=\"guide/service-worker-devops\">Service Worker in Production</a>.</p>\n\n</li>\n</ul>\n\n  \n</div>\n\n\n<!-- links to this doc:\n - api/service-worker/SwUpdate\n - api/service-worker/UnrecoverableStateEvent\n - api/service-worker/UpdateActivatedEvent\n - api/service-worker/UpdateAvailableEvent\n - guide/service-worker-devops\n - guide/service-worker-getting-started\n - guide/service-worker-intro\n-->\n<!-- links from this doc:\n - api/core/ApplicationRef\n - api/core/ApplicationRef#isStable\n - api/core/Injectable\n - api/service-worker/ServiceWorkerModule\n - api/service-worker/SwRegistrationOptions#registrationStrategy\n - api/service-worker/SwUpdate\n - api/service-worker/UnrecoverableStateEvent\n - guide/service-worker-communications#available-and-activated-updates\n - guide/service-worker-communications#checking-for-updates\n - guide/service-worker-communications#forcing-update-activation\n - guide/service-worker-communications#handling-an-unrecoverable-state\n - guide/service-worker-communications#more-on-angular-service-workers\n - guide/service-worker-communications#prerequisites\n - guide/service-worker-communications#service-worker-communication\n - guide/service-worker-communications#swupdate-service\n - guide/service-worker-devops\n - guide/service-worker-getting-started\n - https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval\n - https://github.com/angular/angular-cn/edit/aio/aio/content/guide/service-worker-communications.md?message=docs%3A%20请简述你的修改...\n - https://rxjs.dev/api/index/function/interval\n-->"}